{%- import "apostrophe-ui:components/fields.html" as commonFields with context -%}

{%- macro fields(fields, options = {}) -%}
  {%- set groups = apos.schemas.toGroups(fields) -%}
  <div class="apos-modal-schema{% if groups.length > 1 %} apos-modal-schema--with-tabs{% endif %}" data-apos-form>
    <div class="apos-modal-tabs">
      {%- if groups.length > 1 -%}
        {%- for group in groups -%}
          <div class="apos-modal-tab{% if loop.first %} apos-active{% endif %}" data-apos-open-group="{{ group.name }}">
            {{ group.label }}
          </div>
        {%- endfor -%}
      {%- endif -%}
    </div>
    <div class="apos-modal-groups">
      {%- for group in groups -%}
        <div class="apos-modal-group{% if loop.first %} apos-active{% endif %}" data-apos-group="{{ group.name }}">
          <div class="apos-modal-group-inner">
            {%- for field in group.fields -%}
              {{ apos.schemas.field(field) }}
            {%- endfor -%}
          </div>
        </div>
      {%- endfor -%}
    </div>
  </div>
{%- endmacro -%}
{# Output a fieldset for the given field, and call the given #}
{# macro to populate it. Usually not called directly #}

{%- macro fieldset(field, bodyMacro) %}
  <fieldset class="apos-field apos-field-{{ field.type | css }} apos-field-{{ field.name | css }} {{ field.classes }}" data-name="{{ field.name }}" {{ field.attributes }}>
    <label for="{{ name }}" class="apos-field-label">{{ field.label }}</label>
    {{ bodyMacro(field) }}
  </fieldset>
  {# <fieldset class="apos-fieldset apos-fieldset-{{ field.type | css }} apos-fieldset-{{ field.name | css }} {{ field.classes }}" data-name="{{ field.name }}" {{ field.attributes }}>
    <label>{{ __(field.label) }}<span class="apos-required-message">* Required</span><span class="apos-max-message">* Too large</span><span class="apos-error-message">Please correct errors</span></label>
    {{ bodyMacro(field) }}
  </fieldset> #}
{%- endmacro -%}

{# This is used directly to output a text field #}

{%- macro string(field) -%}
  {{ fieldset(field, stringBody) }}
{%- endmacro -%}

{# Usually passed to fieldset() by text(), this can also be called #}
{# directly if you don't want the fieldset #}

{%- macro stringBody(field) -%}
  {%- if field.textarea -%}
    {{ commonFields.textarea(field.name, field.placeholder) }}
  {%- else -%}
    {{ commonFields.string(field.name, field.placeholder) }}
  {%- endif -%}
{%- endmacro -%}

{%- macro integer(field) -%}
  {{ fieldset(field, stringBody) }}
{%- endmacro -%}

{%- macro float(field) -%}
  {{ fieldset(field, stringBody) }}
{%- endmacro -%}

{%- macro slug(field) -%}
  {{ fieldset(field, stringBody) }}
{%- endmacro -%}

{%- macro password(field) -%}
  {{ fieldset(field, passwordBody) }}
{%- endmacro -%}

{%- macro passwordBody(field) -%}
  <input name="{{ field.name }}" type="password">
{%- endmacro -%}

{%- macro tags(field) -%}
  {{ fieldset(field, tagsBody) }}
{%- endmacro -%}

{%- macro tagsBody(field) -%}
  {# Always using this wrapper div makes it easy to use this with #}
  {# selective, and in both standalone and fieldset situations. -Tom #}
  <div class="apos-tags" data-name="{{ field.name }}" data-selective>
    {# Text entry for autocompleting the next item #}
    <input type="text" name="{{ field.name }}" data-autocomplete placeholder="{{ __('Type Here') }}" class="autocomplete" />
    <span class="apos-limit-indicator" data-limit-indicator>{{ __('Limit Reached!') }}</span>
    <span class="apos-ui-container apos-ui-inline-btn" data-add>
      <a href="#" class="apos-ui-btn"><i class="icon icon-plus"></i> Add</a>
    </span>

    <ul data-list class="apos-tag-list">
      <li data-item class="apos-ui-container">
        <span class="label-and-remove apos-ui-btn apos-ui--dark">
          <a href="#" class="apos-tag-remove icon-remove" data-remove></a>
          <span data-label>{{ __('Example label') }}</span>
          {# Link to remove this choice #}
        </span>
      </li>
    </ul>
  </div>
{%- endmacro -%}

{# Maybe fancier later #}
{%- macro email(field) -%}
  {{ fieldset(field, stringBody) }}
{%- endmacro -%}

{# Typically we enhance this with jquery ui datepicker later #}
{%- macro date(field) -%}
  {{ fieldset(field, stringBody) }}
{%- endmacro -%}

{%- macro time(field) -%}
  {{ fieldset(field, stringBody) }}
{%- endmacro -%}

{%- macro checkboxes(field) -%}
  {{ fieldset(field, checkboxesBody) }}
{%- endmacro -%}

{%- macro checkboxesBody(field) -%}
  <ul class="apos-checkbox-choices">
    {%- for choice in field.choices -%}
      <li class="apos-checkbox-choice">
        <label>{{ choice.label }}</label>
        <input type="checkbox" name="{{ field.name }}" value="{{ choice.value }}">
      </li>
    {%- endfor -%}
  </ul>
{%- endmacro -%}

{#
  // If you need to include extra fields on a select option
  // format a JSON string in 'data-extra' like this:
  //
  // <option data-extra='{ "myField": "thing" }' > Label </option>
  //
  // Also see the showFields case below in the formSelectStandalone macro.
  // -matt
#}
{%- macro select(field) -%}
  {%- set selectMultiple = ' apos-fieldset-selectize' if field.selectMultiple else '' -%}
  {% set selectFields = ' apos-fieldset-select-show-fields' if apos.utils.containsProperty(field.choices, 'showFields') else '' %}
  {{ fieldset(field | merge({ classes: selectMultiple + selectFields }), selectBody) }}
{%- endmacro -%}

{# Often used directly in a custom fieldset with other controls #}
{%- macro selectBody(field) -%}
  {{ commonFields.select(field.name, field.choices) }}
  {#<div class="apos-select-wrapper apos-inline-input">
    <select name="{{ field.name }}"
      {% for key, val in _attrs %}
        {{ key }}="{{ val }}"
      {% endfor %}
      data-selectize
    >
      {% for choice in field.choices %}
        <option value="{{ choice.value }}" label="{{ choice.label }}"
        {% if choice.showFields -%}
         data-extra='{ "showFields": "{{ choice.showFields | join(',') }}" }'
        {%- endif %}
        >{{ __(choice.label) }}</option>
      {% endfor %}
    </select>
  </div>#}
{%- endmacro -%}

{# Less ambiguous to work with than a checkbox #}
{%- macro boolean(field) -%}
  {{ fieldset(field, booleanBody) }}
{%- endmacro -%}

{% macro booleanBody(field) %}
  {{ selectBody(field | merge({ choices: [ { value: '1', label: __('Yes') }, { value: '0', label: __('No') }] })) }}
{%- endmacro -%}

{%- macro singleton(field) -%}
  {{ fieldset(field, singletonBody) }}
{%- endmacro -%}

{%- macro singletonBody(field) -%}
  {# js adds this singleton to the dialog #}
  <div data-{{ field.name }}-edit-view></div>
{%- endmacro -%}

{%- macro area(field) -%}
  {{ fieldset(field | merge({ attributes: 'data-editable' }), singletonBody) }}
{%- endmacro -%}

{%- macro areaBody(field) -%}
  {# js adds this area to the dialog #}
  <div data-{{ field.name }}-edit-view></div>
{%- endmacro -%}

{# Currently the join editors can use the same markup, so we have one #}
{# body macro. -Tom #}

{%- macro joinByOne(field) -%}
  {{ fieldset(field, joinBody) }}
{%- endmacro -%}

{%- macro joinByArray(field) -%}
  {{ fieldset(field, joinBody) }}
{%- endmacro -%}

{# ajax populates joins, see apostrophe-docs/views/chooser.html #}
{%- macro joinBody(field) -%}
  <div data-chooser>{# ajax populates me #}</div>
{%- endmacro -%}
